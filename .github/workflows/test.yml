name: Test & Build

# Run on:
# 1. PRs targeting main, DEV, or beta-* → ALL tests (unit + integration + slow)
# 2. Pushes to DEV → Unit tests only (no integration/slow)
# 3. Pushes to beta-* → Unit + integration + slow tests
# 4. Pushes to main → Nothing (branch protection blocks direct pushes)
on:
  push:
    branches:
      - DEV
      - 'beta-*'
  pull_request:
    branches:
      - main
      - DEV
      - 'beta-*'

jobs:
  # Fast unit tests - runs on ALL events (PRs and pushes to DEV/beta-*)
  unit-tests:
    name: Unit Tests (Lint + Build + Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Build
        run: npm run build
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-unit-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/

  # Integration tests - runs on PRs and pushes to beta-* (NOT on DEV pushes)
  # Tests use dynamic chute discovery with warmup validation - they skip gracefully when chutes unavailable
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests
    # Run on PRs (if not from a fork) and on pushes to beta-* branches (but NOT DEV)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'push' && github.ref != 'refs/heads/DEV')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run integration tests
        env:
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
        run: npm run test:integration
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-integration
          path: |
            coverage/
            test-results/

  # Slow tests (video generation, embeddings, LLM truncation)
  # Runs on PRs and pushes to beta-* (NOT on DEV pushes)
  # Tests use dynamic chute discovery with warmup validation - they skip gracefully when chutes unavailable
  slow-tests:
    name: Slow Tests (Video, Embeddings, etc.)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    # Run on PRs (if not from a fork) and on pushes to beta-* branches (but NOT DEV)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'push' && github.ref != 'refs/heads/DEV')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run slow tests
        env:
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
        run: npm run test:slow
      
      - name: Upload slow test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-slow
          path: |
            coverage/
            test-results/

  # Build verification - always required
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 7
    needs: unit-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Check dist folder
        run: |
          test -d dist || (echo "❌ dist folder not found" && exit 1)
          test -f dist/nodes/Chutes/Chutes.node.js || (echo "❌ Chutes node not built" && exit 1)
          test -f dist/nodes/ChutesChatModel/ChutesChatModel.node.js || (echo "❌ ChutesChatModel node not built" && exit 1)
          test -f dist/nodes/ChutesAIAgent/ChutesAIAgent.node.js || (echo "❌ ChutesAIAgent node not built" && exit 1)
          echo "✅ All nodes built successfully"
      
      - name: Test npm pack
        run: |
          npm pack --dry-run
          echo "✅ Package ready for publishing"

